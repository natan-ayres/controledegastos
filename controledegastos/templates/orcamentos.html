{% extends 'base.html' %}
{% block content %}
<div class="bg-gray-100 min-h-screen py-10 px-4">
    <div class="max-w-6xl mx-auto">

        <!-- HEADER -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-red-700 mb-4 sm:mb-0">
                Entradas
            </h1>

            <a href="{% url 'controledegastos:criarorcamento' %}"
               class="bg-red-700 text-white px-5 py-2 rounded-md font-semibold hover:bg-red-800 transition-colors">
                + Nova Entrada
            </a>
        </div>

        <!-- TOGGLE FILTROS (mobile) -->
        <div class="sm:hidden mb-4">
            <button id="toggle-filtro"
                    aria-expanded="false"
                    class="cursor-pointer w-full flex items-center justify-between bg-red-700 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-800 transition-colors">
                <span id="toggle-label">Mostrar filtros</span>
                <span id="toggle-icon" class="ml-2 text-xl">+</span>
            </button>
        </div>

        <!-- FILTROS -->
        <div id="filtro-container" class="bg-white rounded-lg shadow-md p-6 mb-8 hidden sm:block">
            <h2 class="text-lg font-semibold text-red-700 mb-4">Filtrar entradas</h2>

            <form method="GET">

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">

                    <div>
                        <label class="text-sm font-medium text-gray-700">Nome</label>
                        <input name="nome" type="text" value="{{ request.GET.nome }}"
                               class="w-full mt-1 px-3 py-2 border rounded-md">
                    </div>

                    <div>
                        <label class="text-sm font-medium text-gray-700">Descrição</label>
                        <input name="descricao" type="text" value="{{ request.GET.descricao }}"
                               class="w-full mt-1 px-3 py-2 border rounded-md">
                    </div>

                    <div>
                        <label class="text-sm font-medium text-gray-700">Dia</label>
                        <input name="dia" type="number" value="{{ request.GET.dia }}"
                               class="w-full mt-1 px-3 py-2 border rounded-md" placeholder="1–31">
                    </div>

                    <div>
                        <label class="text-sm font-medium text-gray-700">Valor mínimo</label>
                        <input name="valor_min" type="number" step="0.01" value="{{ request.GET.valor_min }}"
                               class="w-full mt-1 px-3 py-2 border rounded-md" placeholder="R$">
                    </div>

                    <!-- NOVO: FILTRAR POR MÊS -->
                    <div>
                        <label class="text-sm font-medium text-gray-700">Mês</label>
                        <input name="mes" type="number" min="1" max="12" value="{{ request.GET.mes }}"
                               class="w-full mt-1 px-3 py-2 border rounded-md" placeholder="1–12">
                    </div>

                    <!-- NOVO: FILTRAR POR ANO -->
                    <div>
                        <label class="text-sm font-medium text-gray-700">Ano</label>
                        <input name="ano" type="number" value="{{ request.GET.ano }}"
                               class="w-full mt-1 px-3 py-2 border rounded-md" placeholder="2025">
                    </div>

                </div>

                <button class="cursor-pointer mt-4 px-6 py-2 bg-red-700 text-white rounded-lg hover:bg-red-800">
                    Aplicar filtro
                </button>
            </form>
        </div>

        <!-- TABELA -->
        <div class="overflow-x-auto bg-white shadow-md rounded-lg">
            <table class="min-w-full table-auto text-left text-gray-700">
                <thead class="bg-red-700 text-white text-sm uppercase">
                    <tr>
                        <th class="px-6 py-3">Nome</th>
                        <th class="px-6 py-3">Valor</th>
                        <th class="px-6 py-3">Data</th>
                        <th class="px-6 py-3">Descrição</th>
                    </tr>
                </thead>

                <tbody class="divide-y divide-gray-200">
                {% for orcamento in page_obj %}
                    <tr onclick="window.location.href='{% url 'controledegastos:orcamento' orcamento.id %}'"
                        class="hover:bg-gray-50 cursor-pointer">
                        <td class="px-6 py-3">{{ orcamento.nome }}</td>
                        <td class="px-6 py-3">R$ {{ orcamento.valor }}</td>
                        <td class="px-6 py-3">{{ orcamento.data|date:"d/m/Y" }}</td>
                        <td class="px-6 py-3">{{ orcamento.descricao|default:"—" }}</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="5" class="text-center py-6 text-gray-500">
                            Nenhuma entrada encontrada.
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- PAGINAÇÃO -->
        <div class="flex justify-center mt-8 space-x-2">
            {% with filtros=request.GET.urlencode|cut:"page=" %}
            {% with filtros=filtros|cut:"&&" %}
                {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}{% if filtros %}&{{ filtros }}{% endif %}"
                   class="cursor-pointer px-4 py-2 bg-white border rounded-md text-red-700 hover:bg-red-700 hover:text-white hover:scale-105 hover:shadow-md transform transition duration-150 focus:outline-none focus:ring-2 focus:ring-red-300">
                    Anterior
                </a>
                {% endif %}

                <span class="px-4 py-2 bg-red-700 text-white rounded-md transition duration-150 hover:opacity-90">
                Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                </span>

                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if filtros %}&{{ filtros }}{% endif %}"
                   class="cursor-pointer px-4 py-2 bg-white border rounded-md text-red-700 hover:bg-red-700 hover:text-white hover:scale-105 hover:shadow-md transform transition duration-150 focus:outline-none focus:ring-2 focus:ring-red-300">
                    Próxima
                </a>
                {% endif %}
            {% endwith %}
            {% endwith %}
        </div>

    </div>
</div>

<!-- SCRIPTS PARA TOGGLE -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    function setupToggle(btnId, containerId, labelId, iconId, openMsg, closeMsg) {
        const btn = document.getElementById(btnId);
        const container = document.getElementById(containerId);
        const label = document.getElementById(labelId);
        const icon = document.getElementById(iconId);

        if (!btn || !container) return;

        btn.addEventListener('click', () => {
            const open = container.classList.toggle('hidden');
            label.textContent = open ? closeMsg : openMsg;
            icon.textContent = open ? "–" : "+";
        });
    }

    setupToggle("toggle-filtro", "filtro-container", "toggle-label", "toggle-icon",
        "Mostrar filtros", "Ocultar filtros");

    setupToggle("toggle-meses", "meses-container", "toggle-meses-label", "toggle-meses-icon",
        "Mostrar meses disponíveis", "Ocultar meses");
});
</script>

{% endblock %}
